---
title: "GAMM example"
author: "Krista Kraskura and Terra Dressler"
date: "8/18/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Abbreviations...

- GAM(M):
- GLMM:
- PQL:
- LTR:
- AIC:
- BIC:

### Resources:
 - https://cran.r-project.org/web/packages/gamair/gamair.pdf
 - https://mfasiolo.github.io/mgcViz/reference/gammV.html
 - http://web.mit.edu/~r/current/arch/i386_linux26/lib/R/library/mgcv/html/mgcv-FAQ.html
 - http://converged.yt/talks/creemcrackers-splines/talk.pdf
 
### Research articles about GAMM
 - https://peerj.com/articles/6876/
 
### Research articles using GAMM in biological sciences

## GAMM Kyles Presentatation's and general overview 

**When to use?**

We might want to allow for nonlinear predictors while also including random effects to account for
spatiotemporal structure etc.

When estimating GAMMs as a mixed model, we need to compute confidence /credible intervals as for GAM. Beta now contains both i) all the *fixed  effects* and the *random effects* for the smooth terms (only). 

Same message from Kyle's lecture: 

Sometimes a random effects model is required with a large number of smooth curves, which really are the random effects. That is, we might have a random smooth curve per subject, these can  be set up to be efficiently computed in `gamm` anf `gamm4` (see below using "`fs`" basis (Wood 2017).

## GAMMs in R: 

There are two main libraries that will do GAMs and GAMMs. 

- `mgcv` [insert link] includes `gamm` function which fits GAMMs based on linear models as implemented in `nlme` library. 
- `gamm4` [insert link] includes `gamm4` function which fits GAMMs based on linear models implemented in `lme4`. 

Pros Cons: 
[make a table]:
`mgcv`: This gives full access to random effects and correlation structure, just as it is available in `lme`. Work hard with optimization because it is hard separate out a trend from correlation. Hard work for model optimizer. It's easy to make model that runs into numerical problems of estimation. Function performs re-parameterization directly or as a part of PQL iteration.
`gamm4`: Does not give correlation structure, does not rely on PQL for GLMM estimation. It relies on [insert].

`gamm4` or  `mgcv`? much more efficient with crossed random effects, not so with nested.  [give example]
Notice that both have the "additive model" part and "linear mixed effect" part. `$gam` and `$mer`

#### Random effects vs fixed effects

**2.1** When to use mixed model? what determined random effect structure?

**2.2** Benefits using mixed GAMM in place of GAM
Mixed modelling functions are typically set to compute and converge efficiently using the sparsity structures of the random effect in ways that *not*-mixed models are not (e.g. `gam`)

The random effects are included in GAM using `s(..., bs="re")`

#### Real examples

```{r, message=FALSE}
library(mgcv)
library(gamm4)
library(gamair)
library(MASS)
library(lme4)
library(lattice)

```



#### 1.  Temperature in Ciaro 


#### 1.1. Wood's 'mgcv' approach 

``` {r }

## 7.7.2 Cairo temperature
data(cairo)
ctamm <- gamm(temp ~ s(day.of.year,bs="cc",k=20) + s(time, bs="cr"), data=cairo, correlation = corAR1(form=~1|year))
summary(ctamm$gam)


intervals(ctamm$lme,which="var-cov")
ctamm$gam$sig2/ctamm$gam$sp
plot(ctamm$gam,scale=0,pages=1)

REML <- rho <- 0.6+0:20/100
for (i in 1:length(rho)) {
ctbam <- bam(temp~s(day.of.year,bs="cc",k=20)+s(time,bs="cr"),
data=cairo,rho=rho[i])
REML[i] <- ctbam$gcv.ubre
}
rho[REML==min(REML)]

```

#### 1.2. 'gamm4' approach 

``` {r}
data(cairo)
br <- gamm4(temp ~ s(day.of.year) + s(time) , data=cairo, random=~(1|year))

plot(br$gam,pages=1)

```


#### 2. Random wiggly data

What is the data like? 

``` {r}

data(sitka)
head(sitka)
str(sitka)

```

Now let's actually look at it: 
``` {r }
xyplot(log.size~days|as.factor(ozone),data=sitka,type="l",groups=id.num)

```



#### 2.1. Wood's 'mgcv' approach 






``` {r}
sitka$id.num <- as.factor(sitka$id.num)
b <- gamm(log.size~s(days) + ozone + ozone:days + s(days,id.num,bs="fs",k=5), data=sitka)

plot(b$gam,pages=1)

```








